#!/bin/bash

# build first with:
pushd ~/SOLA/WebAssembly/fuzzing/public-project-repo/fuzzm-project/wasm_instrumenter/
cargo build --bin canaries
popd

# instrument
~/SOLA/WebAssembly/fuzzing/public-project-repo/fuzzm-project/wasm_instrumenter/target/debug/canaries vuln.wasm vuln.canaries.wasm --skip-print
chmod +x vuln.canaries.wasm

# execute uninstrumented: file write exploit works!
echo -e "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBBBBBBBdanger\x00\x00\x00w\x00echo 'This is dangerous :-('" | wasmtime --dir=. vuln.wasm
# execute with canaries: unreachable trap before file write exploit is effective :)
echo -e "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBBBBBBBdanger\x00\x00\x00w\x00echo 'This is dangerous :-('" | wasmtime --dir=. vuln.canaries.wasm
